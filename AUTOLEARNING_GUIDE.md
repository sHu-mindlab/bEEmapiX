# 🎓 Auto-Learning Temperature Monitor - Ръководство

## 🌟 Нови възможности във v3.0

- ✅ **Автоматично учене** на позициите на сензорите чрез загряване
- ✅ **Енергонезависима памет** - запазване при рестарт
- ✅ **dev_num** вместо device_id (по-кратък номер)
- ✅ **HTTPS поддръжка** за Render.com
- ✅ **GPIO 8** за OneWire
- ✅ **Serial команди** за управление

---

## 🚀 Първо стартиране (Learning Mode)

### Стъпка 1: Качете кода

```
temp_monitor_v3_autolearn.ino → ESP32-C3
```

### Стъпка 2: Отворете Serial Monitor (115200 baud)

Ще видите:

```
╔════════════════════════════════════════════════════════╗
║              🔥 LEARNING MODE АКТИВИРАН 🔥            ║
╚════════════════════════════════════════════════════════╝

📋 ИНСТРУКЦИИ:
───────────────────────────────────────────────────────
1. ЗАГРЕЙТЕ ПЪРВИЯ СЕНЗОР (позиция [0,0])
2. Изчакайте да се открие и запише
3. ЗАГРЕЙТЕ ВТОРИЯ СЕНЗОР (позиция [0,1])
4. Продължете в реда:
   [0,0] → [0,1] → [0,2] → ... → [0,6]
   [1,0] → [1,1] → [1,2] → ... → [1,6]
   [2,0] → [2,1] → [2,2] → ... → [2,6]
───────────────────────────────────────────────────────

🔥 Загрейте сензор за позиция [0,0]...
```

### Стъпка 3: Загрейте първия сензор

**Методи за загряване:**
- 👐 Хванете с ръка (10-15 секунди)
- 🔥 Феш (5 секунди)
- ☕ Чаша топла вода (потопете за 3 секунди)
- 💨 Дъх от уста (близо до сензора)

**Изисква се промяна > 1.5°C**

### Стъпка 4: Изчакайте потвърждение

```
╔════════════════════════════════════════════════════════╗
║  ✅ СЕНЗОР #1 НАУЧЕН - Позиция [0,0]              ║
╚════════════════════════════════════════════════════════╝
   Адрес: 28:aa:bb:cc:dd:ee:ff:01
   Промяна: +3.25°C
   Прогрес: 1/21 сензора

🔥 Загрейте следващия сензор за позиция [0,1]...
```

### Стъпка 5: Повторете за всички 21 сензора

Редът е:

```
     Col0   Col1   Col2   Col3   Col4   Col5   Col6
    ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐
R0  │  1  │  2  │  3  │  4  │  5  │  6  │  7  │
    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤
R1  │  8  │  9  │ 10  │ 11  │ 12  │ 13  │ 14  │
    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤
R2  │ 15  │ 16  │ 17  │ 18  │ 19  │ 20  │ 21  │
    └─────┴─────┴─────┴─────┴─────┴─────┴─────┘
```

### Стъпка 6: Завършване

След 21-вия сензор:

```
╔════════════════════════════════════════════════════════╗
║         🎉 LEARNING ЗАВЪРШЕН УСПЕШНО! 🎉             ║
╚════════════════════════════════════════════════════════╝

💾 Мапингът е запазен в енергонезависимата памет!

📋 НАУЧЕН МАПИНГ:
───────────────────────────────────────────────────────
Ред 0: [28:aa:...] [28:bb:...] [28:cc:...] ...
Ред 1: [28:dd:...] [28:ee:...] [28:ff:...] ...
Ред 2: [28:11:...] [28:22:...] [28:33:...] ...
───────────────────────────────────────────────────────

✅ Системата преминава в нормална работа!
```

---

## 🔄 Следващи стартирания

При рестарт или power cycle:

```
📚 Зареждане на сензорен мапинг...
✓ Намерен запазен мапинг в паметта!
  [0,0]: 28:aa:bb:cc:dd:ee:ff:01
  [0,1]: 28:11:22:33:44:55:66:77
  ...

✅ Мапингът е зареден. Нормална работа.
```

**Не е нужно повторно учене!** Мапингът е запазен завинаги.

---

## 🎯 Предимства на Auto-Learning

| Предимство | Описание |
|------------|----------|
| 🚀 **Бързо** | Не е нужно ръчно мапиране на адреси |
| 🎯 **Точно** | Физическата позиция = позиция в матрицата |
| 💾 **Постоянно** | Запазено в EEPROM, не се губи при рестарт |
| 🔧 **Лесно** | Просто загрейте в правилния ред |
| 🔄 **Ремапване** | Лесно пренареждане с RESET команда |

---

## 🛠️ Serial команди

### RESET - Изтриване на мапинг

В Serial Monitor напишете:

```
RESET
```

Отговор:

```
⚠ Изтриване на запазения мапинг...
✓ Мапингът е изтрит. Рестартирайте устройството.
```

След рестарт ще стартира нов Learning Mode.

---

## 📊 JSON формат (нов)

```json
{
  "dev_num": 45821,
  "timestamp": 123456789,
  "rows": 3,
  "cols": 7,
  "temperature_grid": [
    [21.5, 21.6, 21.7, 21.8, 21.9, 22.0, 22.1],
    [22.2, 22.3, 22.4, 22.5, 22.6, 22.7, 22.8],
    [22.9, 23.0, 23.1, 23.2, 23.3, 23.4, 23.5]
  ],
  "statistics": {
    "min_temp": 21.5,
    "max_temp": 23.5,
    "avg_temp": 22.5,
    "valid_readings": 21
  }
}
```

**Промени:**
- `device_id` → `dev_num` (16-битово число)
- По-компактен формат

---

## 🔐 HTTPS конфигурация

```cpp
const char* SERVER_URL = "https://koshx-monitoring-server.onrender.com:443/api/temperature";
```

**Важно:** Кодът използва `client.setInsecure()` за тестване.

За production, добавете SSL сертификат:

```cpp
const char* root_ca = \
"-----BEGIN CERTIFICATE-----\n" \
"MIIDxTCCAq2gAwIBAgIQAqxcJmoLQJuPC3nyrkYldzANBgkqhkiG9w0BAQUFADBs\n" \
// ... вашият CA сертификат
"-----END CERTIFICATE-----\n";

// В sendData():
client.setCACert(root_ca);
// вместо client.setInsecure();
```

---

## ⚙️ Конфигурация

### WiFi

```cpp
const char* WIFI_SSID = "Hotspot_10";
const char* WIFI_PASSWORD = "dedaznam";
```

### Server

```cpp
const char* SERVER_URL = "https://koshx-monitoring-server.onrender.com:443/api/temperature";
```

### GPIO пин

```cpp
#define ONE_WIRE_BUS 8  // GPIO8
```

### Периоди

```cpp
unsigned long MEASUREMENT_PERIOD = 5000;   // 5 сек
unsigned long SEND_PERIOD = 60000;         // 60 сек
```

---

## 💾 Енергонезависима памет (Preferences)

Използва ESP32 Preferences API (NVS - Non-Volatile Storage):

```cpp
preferences.begin("sensor-map", false);
preferences.putBytes(key, address, 8);
preferences.putBool("complete", true);
preferences.end();
```

**Капацитет:**
- Общо ~12KB NVS памет
- Всеки адрес: 8 байта
- 21 сензора × 8 байта = 168 байта (< 2% от капацитета)

**Издръжливост:**
- ~100,000 write/erase цикъла
- При нормална употреба - десетилетия

---

## 🎨 Визуализация на процеса

### Първоначално състояние

```
Всички сензори на стайна температура (~22°C)
```

### Загряване на първи сензор

```
[0,0]: 26.5°C ← ЗАГРЯТ! (+4.5°C)
[0,1]: 21.8°C
[0,2]: 22.1°C
...
```

### След откриване

```
✅ Сензор #1 научен → [0,0]
Запазен адрес: 28:aa:bb:cc:dd:ee:ff:01
```

### Повторение

```
[0,0]: 26.5°C ← Вече научен
[0,1]: 25.3°C ← ЗАГРЯТ! (+3.3°C) → Учи се сега
[0,2]: 22.0°C
...
```

---

## ⚠️ Често срещани проблеми

### Проблем 1: "Този сензор вече е научен!"

**Причина:** Загряхте грешен сензор (вече научен преди)

**Решение:** Загрейте правилния следващ сензор в последователността

### Проблем 2: Не се открива загряване

**Причина:** Промяната е под 1.5°C

**Решение:** 
- Загрявайте по-дълго
- Използвайте по-топъл източник (феш, топла вода)
- Проверете дали сензорът работи (виждайте diagnostic скрипта)

### Проблем 3: Learning не стартира

**Причина:** Вече има запазен мапинг

**Решение:** Изпратете `RESET` в Serial Monitor и рестартирайте

### Проблем 4: Загубва се при рестарт

**Причина:** Preferences не са правилно запазени

**Решение:**
- Уверете се че learning е завършен докрай (всичките 21)
- Проверете Serial Monitor за съобщение "💾 Мапингът е запазен"

---

## 🔄 Workflow диаграма

```
┌─────────────────┐
│  Първи старт    │
└────────┬────────┘
         │
         ▼
    ┌─────────┐     Да    ┌──────────────┐
    │ Има NVS?├──────────►│ Зареди мапинг│
    └────┬────┘            └──────┬───────┘
         │ Не                     │
         ▼                        │
┌──────────────────┐              │
│ Learning Mode    │              │
│ Загрей 21 сензора│              │
└────────┬─────────┘              │
         │                        │
         ▼                        │
    ┌─────────┐                   │
    │ Запази  │                   │
    │ в NVS   │                   │
    └────┬────┘                   │
         │                        │
         └────────┬───────────────┘
                  ▼
         ┌─────────────────┐
         │ Нормална работа │
         │ Измерване +     │
         │ Изпращане       │
         └─────────────────┘
```

---

## 📈 Статистики

След успешно учене:

```
Памет използвана: 168 байта (0.16 KB)
Време за учене: ~5 минути (21 × ~15 сек)
Валидност: Завинаги (докато не изтриете)
Write cycles: 1 път (при първо учене)
```

---

## 🎓 Съвети за ефективно учене

1. ✅ **Подгответе всичко предварително**
   - 21 сензора монтирани
   - Феш или топла вода наготово

2. ✅ **Работете систематично**
   - Следвайте реда: [0,0]→[0,1]→...
   - Маркирайте научените (стикер)

3. ✅ **Изчаквайте потвърждение**
   - Не продължавайте преди "✅ НАУЧЕН"

4. ✅ **Документирайте**
   - Правете снимки на разположението
   - Копирайте Serial output-а

5. ✅ **Тествайте след приключване**
   - Загрейте познат сензор
   - Проверете дали позицията съвпада

---

**Готово! Вече имате напълно автоматизирана система за температурен мониторинг!** 🎉
